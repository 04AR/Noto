<!doctype html>
<html lang="en">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>EPUB Reader (single file)</title>
  <style>
    :root {
      --bg: #111827;
      --panel: #1f2937;
      --text: #e5e7eb;
      --muted: #9ca3af;
      --accent: #3b82f6;
      --border: #374151;
      --card-bg: rgba(31, 41, 55, 0.9);
      --card-border: #4b5563;
    }
    .light {
      --bg: #f9fafb;
      --panel: #ffffff;
      --text: #1f2937;
      --muted: #6b7280;
      --accent: #2563eb;
      --border: #e5e7eb;
      --card-bg: rgba(255, 255, 255, 0.9);
      --card-border: #d1d5db;
    }
    * { box-sizing: border-box; }
    html, body { height: 100%; margin: 0; }
    body {
      background: var(--bg);
      color: var(--text);
      font-family: system-ui, -apple-system, Segoe UI, Roboto, Helvetica, Arial, "Apple Color Emoji", "Segoe UI Emoji";
      display: grid;
      grid-template-rows: auto 1fr;
      overflow: hidden;
      transition: color 0.3s ease, background-color 0.3s ease;
    }
    header {
      display: flex; justify-content: space-between; align-items: center; padding: 0.75rem 1rem;
      background: var(--panel); border-bottom: 1px solid var(--border);
      transition: background-color 0.3s ease, border-color 0.3s ease;
    }
    .controls-group { display: flex; align-items: center; gap: 0.5rem; }
    button, label[role="button"] {
      border: 1px solid var(--border); background: transparent; color: var(--text);
      padding: 0.4rem 0.7rem; border-radius: 0.6rem; cursor: pointer; font-weight: 600;
      transition: background-color 0.3s ease, border-color 0.3s ease, color 0.3s ease, opacity 0.3s ease;
    }
    button:hover, label[role="button"]:hover { border-color: var(--accent); }
    input[type="file"] { display: none; }
    .hint { color: var(--muted); font-size: 0.9rem; }

    .reader-container {
      position: relative; height: 100%; overflow: hidden;
    }
    #viewer {
      width: 100%; height: 100%;
    }
    .nav-btn {
      position: absolute; top: 50%; transform: translateY(-50%); z-index: 10;
      background: var(--card-bg); border: 1px solid var(--card-border); color: var(--text);
      padding: 1rem 0.75rem; border-radius: 0.6rem; cursor: pointer; opacity: 0;
      transition: opacity 0.3s ease, transform 0.3s ease;
      font-size: 1.5rem; line-height: 1; user-select: none;
    }
    .reader-container:hover .nav-btn { opacity: 1; }
    #prevBtn { left: 1rem; }
    #nextBtn { right: 1rem; }
    .disabled { opacity: 0 !important; pointer-events: none; }

    .toc-panel {
      position: absolute; top: 0; left: 0; width: 280px; height: 100%;
      background: var(--panel); border-right: 1px solid var(--border);
      transform: translateX(-100%); transition: transform 0.3s ease; z-index: 20;
      display: flex; flex-direction: column; overflow: hidden;
    }
    .toc-panel.show { transform: translateX(0); }
    .toc-panel h3 { margin: 0.75rem 1rem; font-size: 0.95rem; color: var(--muted); }
    .toc { list-style: none; padding: 0; margin: 0; overflow-y: auto; flex-grow: 1; }
    .toc li {
      padding: 0.35rem 1rem; border-left: 3px solid transparent;
      white-space: nowrap; overflow: hidden; text-overflow: ellipsis;
      cursor: pointer; transition: background-color 0.2s ease, border-left-color 0.2s ease;
    }
    .toc li:hover { background: rgba(76,139,245,.08); border-left-color: var(--accent); }
    .toc .active { background: rgba(76,139,245,.14); border-left-color: var(--accent); }

    .reader-controls {
      position: absolute; bottom: 1rem; left: 50%; transform: translateX(-50%);
      display: flex; align-items: center; gap: 0.75rem;
      background: var(--card-bg); border: 1px solid var(--card-border);
      padding: 0.5rem 1rem; border-radius: 9999px;
      opacity: 0; transition: opacity 0.3s ease, transform 0.3s ease;
      backdrop-filter: blur(10px); -webkit-backdrop-filter: blur(10px);
    }
    .reader-container:hover .reader-controls { opacity: 1; }
  </style>
  <!-- JSZip (required by epub.js) -->
  <script src="https://cdnjs.cloudflare.com/ajax/libs/jszip/3.10.1/jszip.min.js"></script>
  <!-- epub.js -->
  <script src="https://cdn.jsdelivr.net/npm/epubjs@0.3/dist/epub.min.js"></script>
</head>
<body>
  <header>
    <div class="controls-group">
      <button id="tocToggle" title="Toggle Contents">â˜°</button>
      <span class="hint">EPUB Reader</span>
    </div>
    <div class="controls-group">
      <span id="bookTitle" class="hint">No book loaded</span>
    </div>
    <div class="controls-group">
      <button id="modeToggle" title="Toggle flow mode">â†• / â†”</button>
      <button id="themeToggle" title="Toggle theme">ðŸŒ—</button>
      <label role="button" for="fileInput" title="Load Book">ðŸ“˜</label>
      <input id="fileInput" type="file" accept=".epub,application/epub+zip" />
    </div>
  </header>

  <main class="reader-container">
    <div id="viewer"></div>
    <!-- Previous/Next buttons -->
    <button id="prevBtn" class="nav-btn">â—€</button>
    <button id="nextBtn" class="nav-btn">â–¶</button>
    <!-- Table of Contents Panel -->
    <aside id="tocPanel" class="toc-panel">
      <h3>Contents</h3>
      <ul id="toc" class="toc"></ul>
    </aside>
    <!-- Floating Reader Controls -->
    <div id="readerControls" class="reader-controls">
      <span id="modeHint" class="hint">Paginated</span>
      <span id="pageInfo" class="hint"></span>
    </div>
    <div id="dropzone" class="drop">Drop .epub file here</div>
  </main>

  <script>
    let rendition = null;
    let book = null;
    let currentMode = localStorage.getItem('flowMode') || 'paginated';
    let isLight = localStorage.getItem('theme') === 'light';
    let currentBookKey = null;

    function applyTheme() {
      document.body.classList.toggle('light', isLight);
      if (rendition) {
        const cs = getComputedStyle(document.body);
        rendition.themes.default({
          body: {
            background: cs.getPropertyValue('--bg').trim(),
            color: cs.getPropertyValue('--text').trim(),
            lineHeight: '1.6',
            padding: '1rem'
          },
          a: { color: cs.getPropertyValue('--accent').trim() }
        });
        rendition.themes.fontSize('100%');
      }
    }

    function setModeHint() {
      const hint = document.getElementById('modeHint');
      const isPaginated = currentMode === 'paginated';
      hint.textContent = isPaginated ? 'Paginated' : 'Scrolled';
      document.getElementById('prevBtn').classList.toggle('disabled', !isPaginated);
      document.getElementById('nextBtn').classList.toggle('disabled', !isPaginated);
    }

    async function loadBookFromArrayBuffer(arrayBuffer, fileNameForKey = '') {
      try { if (rendition) { rendition.destroy(); } } catch (_) {}
      try { if (book) { await book.destroy?.(); } } catch (_) {}

      book = ePub(arrayBuffer);
      currentBookKey = 'lastLocation:' + (fileNameForKey || '');
      document.getElementById('bookTitle').textContent = book.metadata?.title || 'Untitled';

      const viewer = document.getElementById('viewer');
      viewer.innerHTML = '';
      rendition = book.renderTo('viewer', {
        width: '100%',
        height: '100%',
        flow: currentMode,
        spread: 'auto'
      });

      applyTheme();
      setModeHint();

      rendition.on('relocated', (location) => {
        const pageInfo = document.getElementById('pageInfo');
        if (location.atEnd || location.atStart) {
          pageInfo.textContent = '';
          return;
        }

        if (location.start.page && location.start.pages) {
          pageInfo.textContent = `Page ${location.start.page} of ${location.start.pages}`;
        } else {
          const totalLocations = book.locations.length;
          const currentProgress = location.start.location;
          const percentage = totalLocations > 0 ? Math.round((currentProgress / totalLocations) * 100) : 0;
          pageInfo.textContent = `Progress: ${percentage}%`;
        }
      });

      const last = localStorage.getItem(currentBookKey);
      if (last) { await rendition.display(last).catch(() => rendition.display()); }
      else { await rendition.display(); }

      populateTOC();
      rendition.on('relocated', (loc) => {
        const cfi = loc.start.cfi;
        if (currentBookKey && cfi) localStorage.setItem(currentBookKey, cfi);
        highlightTOCByHref(loc.start?.href);
      });

      book.ready.then(() => book.locations.generate(1000));
    }

    async function populateTOC() {
      const tocEl = document.getElementById('toc');
      tocEl.innerHTML = '';
      try {
        const nav = await book.loaded.navigation;
        const items = (nav?.toc || []);
        for (const item of items) {
          const li = document.createElement('li');
          li.textContent = (item.label || '').trim() || item.href;
          li.dataset.href = item.href;
          li.addEventListener('click', () => {
            rendition.display(item.href);
            document.getElementById('tocPanel').classList.remove('show');
          });
          tocEl.appendChild(li);
        }
      } catch (_) {}
    }

    function highlightTOCByHref(href) {
      const tocEl = document.getElementById('toc');
      [...tocEl.children].forEach(li => li.classList.remove('active'));
      if (!href) return;
      const match = [...tocEl.children].find(li => href.includes(li.dataset.href));
      if (match) match.classList.add('active');
    }

    document.getElementById('prevBtn').addEventListener('click', () => {
      if (currentMode === 'paginated' && rendition) rendition.prev();
    });
    document.getElementById('nextBtn').addEventListener('click', () => {
      if (currentMode === 'paginated' && rendition) rendition.next();
    });

    document.getElementById('modeToggle').addEventListener('click', () => {
      currentMode = currentMode === 'paginated' ? 'scrolled-doc' : 'paginated';
      localStorage.setItem('flowMode', currentMode);
      setModeHint();
      if (rendition) rendition.flow(currentMode);
    });

    document.getElementById('themeToggle').addEventListener('click', () => {
      isLight = !isLight;
      localStorage.setItem('theme', isLight ? 'light' : 'dark');
      applyTheme();
    });

    document.getElementById('fileInput').addEventListener('change', async (e) => {
      const file = e.target.files?.[0];
      if (!file) return;
      const buf = await file.arrayBuffer();
      await loadBookFromArrayBuffer(buf, file.name || '');
    });

    document.getElementById('tocToggle').addEventListener('click', () => {
      document.getElementById('tocPanel').classList.toggle('show');
    });

    const drop = document.getElementById('dropzone');
    const viewer = document.getElementById('viewer');
    ['dragenter','dragover'].forEach(ev => {
      viewer.addEventListener(ev, (e) => {
        e.preventDefault(); drop.classList.add('show');
      });
    });
    ['dragleave','drop'].forEach(ev => {
      viewer.addEventListener(ev, (e) => {
        e.preventDefault();
        if (ev === 'drop') {
          const file = e.dataTransfer?.files?.[0];
          if (file && (file.type === 'application/epub+zip' || file.name.toLowerCase().endsWith('.epub'))) {
            file.arrayBuffer().then(buf => loadBookFromArrayBuffer(buf, file.name || ''));
          }
        }
        drop.classList.remove('show');
      });
    });

    applyTheme();
    setModeHint();

    window.addEventListener('keydown', (e) => {
      if (!rendition) return;
      if (currentMode === 'paginated') {
        if (e.key === 'ArrowRight' || e.key === 'PageDown') rendition.next();
        if (e.key === 'ArrowLeft'  || e.key === 'PageUp')   rendition.prev();
      }
    });

    window.addEventListener('resize', () => {
      if (rendition) {
        rendition.resize();
      }
    });
  </script>
</body>
</html>
